name: MinGW-w64 Build

permissions:
  contents: read
  pull-requests: write

on:
  push:
    branches:
      - mingw-w64-build
      - mingw-w64-build-ci
  pull_request:
    branches:
      - main
      - mingw-w64-build
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: ${{ github.event_name == 'pull_request' }}

jobs:
  detect-changes:
    name: Detect File Changes
    runs-on: ubuntu-latest
    timeout-minutes: 5
    outputs:
      generals: ${{ steps.filter.outputs.generals }}
      generalsmd: ${{ steps.filter.outputs.generalsmd }}
      shared: ${{ steps.filter.outputs.shared }}
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Filter Changed Paths
        uses: dorny/paths-filter@v3
        id: filter
        with:
          token: ''
          filters: |
            generals:
              - 'Generals/**'
            generalsmd:
              - 'GeneralsMD/**'
            shared:
              - '.github/workflows/**'
              - 'CMakeLists.txt'
              - 'CMakePresets.json'
              - 'cmake/**'
              - 'Core/**'
              - 'Dependencies/**'

      - name: Changes Summary
        run: |
          echo "### ðŸ” File Changes Summary" >> $GITHUB_STEP_SUMMARY
          echo "- Generals: ${{ steps.filter.outputs.generals == 'true' && 'âœ…' || 'âŒ' }}" >> $GITHUB_STEP_SUMMARY
          echo "- GeneralsMD: ${{ steps.filter.outputs.generalsmd == 'true' && 'âœ…' || 'âŒ' }}" >> $GITHUB_STEP_SUMMARY
          echo "- Shared: ${{ steps.filter.outputs.shared == 'true' && 'âœ…' || 'âŒ' }}" >> $GITHUB_STEP_SUMMARY

  build-mingw:
    name: MinGW-w64 Build ${{ matrix.game }} (${{ matrix.preset }})
    needs: detect-changes
    if: ${{ github.event_name == 'workflow_dispatch' || needs.detect-changes.outputs.generals == 'true' || needs.detect-changes.outputs.generalsmd == 'true' || needs.detect-changes.outputs.shared == 'true' }}
    runs-on: ubuntu-latest
    timeout-minutes: 45
    strategy:
      matrix:
        game: ["Generals", "GeneralsMD"]
        preset: ["mingw-w64-i686", "mingw-w64-i686-debug", "mingw-w64-i686-profile"]
      fail-fast: false

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Cache MinGW-w64 Dependencies
        id: cache-mingw-deps
        uses: actions/cache@v4
        with:
          path: |
            /usr/lib/gcc/i686-w64-mingw32
            /usr/i686-w64-mingw32
          key: mingw-w64-deps-${{ runner.os }}-v1

      - name: Install MinGW-w64 Toolchain
        run: |
          echo "### ðŸ”§ Installing MinGW-w64 Toolchain" >> $GITHUB_STEP_SUMMARY
          sudo apt-get update
          sudo apt-get install -y mingw-w64 cmake
          
          # Verify installation
          i686-w64-mingw32-gcc --version
          cmake --version
          
          echo "âœ… MinGW-w64 installation complete" >> $GITHUB_STEP_SUMMARY

      - name: Install Wine and widl
        run: |
          echo "### ðŸ· Installing Wine and widl" >> $GITHUB_STEP_SUMMARY
          
          # Add Wine repository
          sudo dpkg --add-architecture i386
          sudo mkdir -pm755 /etc/apt/keyrings
          sudo wget -O /etc/apt/keyrings/winehq-archive.key https://dl.winehq.org/wine-builds/winehq.key
          
          # Determine Ubuntu codename
          CODENAME=$(lsb_release -cs)
          echo "Ubuntu codename: $CODENAME"
          
          # Download appropriate sources file
          sudo wget -NP /etc/apt/sources.list.d/ https://dl.winehq.org/wine-builds/ubuntu/dists/${CODENAME}/winehq-${CODENAME}.sources || {
            echo "âš ï¸ Wine sources file not found for $CODENAME, trying jammy as fallback" >> $GITHUB_STEP_SUMMARY
            sudo wget -NP /etc/apt/sources.list.d/ https://dl.winehq.org/wine-builds/ubuntu/dists/jammy/winehq-jammy.sources
          }
          
          # Update and install Wine
          sudo apt-get update
          sudo apt-get install -y --install-recommends winehq-stable wine-stable-dev || {
            echo "âš ï¸ Full Wine installation failed, installing minimal wine-stable-dev" >> $GITHUB_STEP_SUMMARY
            sudo apt-get install -y wine-stable-dev
          }
          
          # Verify widl installation
          widl --version || echo "âš ï¸ widl not found in PATH, build may use fallback" >> $GITHUB_STEP_SUMMARY
          
          echo "âœ… Wine and widl installation complete" >> $GITHUB_STEP_SUMMARY

      - name: Cache CMake Dependencies
        id: cache-cmake-deps
        uses: actions/cache@v4
        with:
          path: build/${{ matrix.preset }}/_deps
          key: cmake-deps-mingw-${{ matrix.preset }}-${{ hashFiles('CMakePresets.json','cmake/**/*.cmake','**/CMakeLists.txt') }}

      - name: Configure ${{ matrix.game }} with CMake (${{ matrix.preset }})
        run: |
          echo "### âš™ï¸ Configuring ${{ matrix.game }} (${{ matrix.preset }})" >> $GITHUB_STEP_SUMMARY
          
          # Unset LD_LIBRARY_PATH to avoid library conflicts
          unset LD_LIBRARY_PATH
          
          # Configure with appropriate flags
          cmake --preset ${{ matrix.preset }} \
            -DRTS_BUILD_ZEROHOUR=${{ matrix.game == 'GeneralsMD' && 'ON' || 'OFF' }} \
            -DRTS_BUILD_GENERALS=${{ matrix.game == 'Generals' && 'ON' || 'OFF' }} \
            -DRTS_BUILD_CORE_TOOLS=OFF \
            -DRTS_BUILD_GENERALS_TOOLS=OFF \
            -DRTS_BUILD_ZEROHOUR_TOOLS=OFF \
            -DRTS_BUILD_CORE_EXTRAS=OFF \
            -DRTS_BUILD_GENERALS_EXTRAS=OFF \
            -DRTS_BUILD_ZEROHOUR_EXTRAS=OFF
          
          echo "âœ… Configuration complete" >> $GITHUB_STEP_SUMMARY

      - name: Build ${{ matrix.game }} (${{ matrix.preset }})
        run: |
          echo "### ðŸ”¨ Building ${{ matrix.game }} (${{ matrix.preset }})" >> $GITHUB_STEP_SUMMARY
          
          # Determine target based on game
          TARGET=${{ matrix.game == 'Generals' && 'g_generals' || 'z_generals' }}
          
          # Build with parallel jobs
          cmake --build build/${{ matrix.preset }} --target $TARGET -j$(nproc)
          
          echo "âœ… Build complete" >> $GITHUB_STEP_SUMMARY

      - name: Verify Executables
        run: |
          echo "### ðŸ” Verifying Executables" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ matrix.game }}" == "Generals" ]; then
            EXE_PATH="build/${{ matrix.preset }}/Generals/generalsv.exe"
          else
            EXE_PATH="build/${{ matrix.preset }}/GeneralsMD/generalszh.exe"
          fi
          
          if [ -f "$EXE_PATH" ]; then
            echo "âœ… Executable found: $EXE_PATH" >> $GITHUB_STEP_SUMMARY
            file "$EXE_PATH" >> $GITHUB_STEP_SUMMARY
            ls -lh "$EXE_PATH" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Executable not found: $EXE_PATH" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

      - name: Collect ${{ matrix.game }} Artifacts
        run: |
          ARTIFACTS_DIR="build/${{ matrix.preset }}/${{ matrix.game }}/artifacts"
          mkdir -p "$ARTIFACTS_DIR"
          
          # Copy executables
          if [ "${{ matrix.game }}" == "Generals" ]; then
            cp build/${{ matrix.preset }}/Generals/generalsv.exe "$ARTIFACTS_DIR/"
          else
            cp build/${{ matrix.preset }}/GeneralsMD/generalszh.exe "$ARTIFACTS_DIR/"
          fi
          
          # Copy any DLLs if they exist
          find build/${{ matrix.preset }}/Core -name "*.dll" -exec cp {} "$ARTIFACTS_DIR/" \; 2>/dev/null || true
          find build/${{ matrix.preset }}/${{ matrix.game }} -name "*.dll" -exec cp {} "$ARTIFACTS_DIR/" \; 2>/dev/null || true
          
          echo "Artifacts collected in $ARTIFACTS_DIR:"
          ls -lh "$ARTIFACTS_DIR"

      - name: Upload ${{ matrix.game }} ${{ matrix.preset }} Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.game }}-${{ matrix.preset }}-mingw-w64
          path: build/${{ matrix.preset }}/${{ matrix.game }}/artifacts
          retention-days: 30
          if-no-files-found: error

  build-summary:
    name: Build Summary
    needs: build-mingw
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Generate Summary
        run: |
          echo "## ðŸŽ‰ MinGW-w64 Build Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Build Status" >> $GITHUB_STEP_SUMMARY
          echo "- **Workflow:** MinGW-w64 Cross-Compilation Build" >> $GITHUB_STEP_SUMMARY
          echo "- **Toolchain:** MinGW-w64 GCC (i686-w64-mingw32)" >> $GITHUB_STEP_SUMMARY
          echo "- **Platform:** Ubuntu Linux â†’ Windows 32-bit" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "Built executables are available as workflow artifacts:" >> $GITHUB_STEP_SUMMARY
          echo "- Generals (Release, Debug, Profile builds)" >> $GITHUB_STEP_SUMMARY
          echo "- Zero Hour / GeneralsMD (Release, Debug, Profile builds)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Executables" >> $GITHUB_STEP_SUMMARY
          echo "- \`generalsv.exe\` - Command & Conquer Generals" >> $GITHUB_STEP_SUMMARY
          echo "- \`generalszh.exe\` - Command & Conquer Generals: Zero Hour" >> $GITHUB_STEP_SUMMARY
