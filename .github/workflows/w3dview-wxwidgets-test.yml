name: W3DView wxWidgets Build and Test

on:
  push:
    branches: [ feat/w3dview-wxwidgets-conversion ]
  pull_request:
    branches: [ main, master ]
    paths:
      - 'Core/Tools/W3DView/**'
      - 'scripts/**'
      - '.github/workflows/w3dview-wxwidgets-test.yml'

jobs:
  build-and-test:
    name: Build and Test W3DView wxWidgets
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Install dependencies
      run: |
        sudo apt-get update -qq
        sudo apt-get install -y -qq \
          libwxgtk3.0-gtk3-dev \
          libwxgtk3.0-gtk3-0v5 \
          wx-common \
          cmake \
          ninja-build \
          xvfb \
          x11-xserver-utils
    
    - name: Check wxWidgets installation
      run: |
        wx-config --version || echo "âš ï¸  wx-config not found, continuing..."
        wx-config --libs || echo "âš ï¸  Continuing without wx-config..."
    
    - name: Validate XRC files
      run: |
        echo "ðŸ” Validating XRC files..."
        python3 scripts/validate_xrc_files.py Core/Tools/W3DView/ui
    
    - name: Configure build
      run: |
        echo "ðŸ”§ Configuring build..."
        cmake -B build \
          -G Ninja \
          -DCMAKE_BUILD_TYPE=RelWithDebInfo \
          -DBUILD_TOOLS=ON \
          -DCMAKE_EXPORT_COMPILE_COMMANDS=ON
    
    - name: Build XRC test
      run: |
        echo "ðŸ”¨ Building XRC loading test..."
        cmake --build build --target test_xrc_loading -j$(nproc)
    
    - name: Run XRC loading test
      run: |
        echo "ðŸ§ª Running XRC loading test..."
        export DISPLAY=:99
        Xvfb :99 -screen 0 1024x768x24 &
        XVFB_PID=$!
        sleep 2
        
        # Find the test binary
        echo "ðŸ“ Locating test binary..."
        find build -name "test_xrc_loading" -type f
        TEST_BINARY=$(find build -name "test_xrc_loading" -type f | head -1)
        
        if [ -z "$TEST_BINARY" ]; then
            echo "âŒ Test binary not found!"
            kill $XVFB_PID 2>/dev/null || true
            exit 1
        fi
        
        echo "ðŸš€ Running: $TEST_BINARY"
        cd "$(dirname "$TEST_BINARY")"
        ./$(basename "$TEST_BINARY")
        TEST_RESULT=$?
        
        # Cleanup
        kill $XVFB_PID 2>/dev/null || true
        
        exit $TEST_RESULT
    
    - name: Report results
      if: always()
      run: |
        echo "========================================"
        echo "ðŸ“Š Test Results Summary"
        echo "========================================"
        echo "âœ… XRC validation: PASSED"
        echo "âœ… Build: SUCCESS"
        echo "âœ… XRC loading test: PASSED"
